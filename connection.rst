
.. _connection_benchmark:

============
并发连接测试-----尹继超
============

该测试场景只测试客户端到服务器端的MQTT协议连接，该测试场景下除了发送MQTT协议的控制包和PING包外，不发送任何用户数据相关的包，测试目的是为了得到EMQ消息服务器在不同并发连接下的表现。

-------
TCP连接
-------

总体结果：EMQx3.0.0在建立100万以内TCP连接的时候，平均响应时间都在8ms以内，成功率为100%。内存的使用基本呈线性增长，CPU在用户连接建立的时候表现平稳，没有大幅度的抖动。但是观察到在连接断开的场景下，会发生CPU使用率会增多


.. NOTE:: 测试机配置：1台虚拟机支持50000 VU (2个docker*25000 VU)

30万线
------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
| 300000            | 1000                     | 1800                 | 909         | 8ms            | 3.143s           | 1ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+


+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
| CPU shortterm Load最大达到4  | CPU使用率在5%-26%之间 | Memory使用随着并发用户量增加而增大，最大到4.9G |
+------------------------------+-----------------------+------------------------------------------------+

 EMQX服务器资源监控：

.. image:: _static/images/tcp_30W.png


50万线
------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
| 500000            | 1000                     | 1800                 | 943         | 7ms            | 2.460s           | 1ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+

+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
| CPU shortterm Load最大达到5  | CPU使用率在15%-40%之间| Memory使用随着并发用户量增加而增大，最大到7.79G|
+------------------------------+-----------------------+------------------------------------------------+

 EMQX服务器资源监控：

.. image:: _static/images/tcp_50W.png


100万线
-------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
| 1000000           | 1000                     | 1800                 | 960         | 7ms            | 3.707s           | 1ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+

+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
| CPU shortterm Load最大达到7  |CPU使用率在20%-50%之间 |Memory使用随着并发用户量增加而增大，最大到22.66G|
+------------------------------+-----------------------+------------------------------------------------+


 EMQX服务器资源监控：

.. image:: _static/images/tcp_100W.png


-----------
SSL单向认证
-----------

总体结果：EMQX在20万连接之内单向认证的连接，并且设置不重新连接的情况下，平均响应时间在34ms以内，成功率为100%，CPU和内存使用基本正常。

.. NOTE:: 测试机配置：1台虚拟机支持20000 VU (2个docker*10000 VU)

10万线
------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
|100000             | 1000                     | 1800                 | 800         | 15ms           | 2.319s           | 6ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+

+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
|CPU shortterm Load最大达到5.52| CPU使用率在10%-65%之间|Memory使用随着并发用户量增加而增大，最大到8.17G |
+------------------------------+-----------------------+------------------------------------------------+

 EMQX服务器资源监控：

.. image:: _static/images/ssl_10W.png


20万线
------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
| 200000            | 1000                     | 1800                 | 870         | 15ms           | 2.479s           | 6ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+

+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
| CPU shortterm Load最大达到7  |CPU使用率在10%-75%之间 |Memory使用随着并发用户量增加而增大，最大到15.53G|
+------------------------------+-----------------------+------------------------------------------------+

 EMQX服务器资源监控：

.. image:: _static/images/ssl_20W.png

-----------
SSL双向认证
-----------

总体结果：EMQX在20万连接之内双向认证的连接，并且设置不重新连接的情况下，平均响应时间在15ms以内，成功率为100%，CPU和内存使用基本正常。

.. NOTE:: 测试机配置：1台虚拟机支持20000 VU (2个docker*10000 VU)

10万线
------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
| 100000            | 1000                     | 1800                 | 769         | 27ms           | 2.700s           | 9ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+


+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
| CPU shortterm Load最大达到6  |CPU使用率在10%-75%之间 |Memory使用随着并发用户量增加而增大，最大到15.81G|
+------------------------------+-----------------------+------------------------------------------------+

 EMQX服务器资源监控：

.. image:: _static/images/dual_10W.png


20万线
------

+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+
| 虚拟用户数量(VU)  |     每秒新增并发链接(CPS)|     总计运行时间(Sec)|  平均吞吐量 |    平均响应时间|      最大响应时间|     最小响应时间| 成功率 |
+===================+==========================+======================+=============+================+==================+=================+========+
| 200000            | 1000                     | 1800                 | 833         | 34ms           | 2.704s           | 9ms             | 100%   |
+-------------------+--------------------------+----------------------+-------------+----------------+------------------+-----------------+--------+

+------------------------------+-----------------------+------------------------------------------------+
|     负载(Load)               |      CPU              |           Memory                               |
+==============================+=======================+================================================+
| CPU shortterm Load最大达到8  |CPU使用率在10%-80%之间 |Memory使用随着并发用户量增加而增大，最大到30.52G|
+------------------------------+-----------------------+------------------------------------------------+

EMQX服务器资源监控：

.. image:: _static/images/dual_20W.png
